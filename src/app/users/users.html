<div class="flex flex-col gap-6 p-6">
  <!-- Page Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold text-gray-800">Users</h1>
      <p class="mt-1 text-sm text-gray-500">
        @if (!loading() && !error()) {
          {{ filteredUsers().length }} of {{ users().length }} users
        }
      </p>
    </div>

    <!-- Search + View Toggle -->
    @if (!loading() && !error()) {
    <div class="flex items-center gap-2">
      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full sm:w-72">
        <mat-icon matPrefix class="!text-gray-400">search</mat-icon>
        <input matInput [formControl]="searchControl" placeholder="Search by name, email, country…" />
        @if (searchControl.value) {
        <button matSuffix mat-icon-button (click)="searchControl.setValue('')" aria-label="Clear search">
          <mat-icon>close</mat-icon>
        </button>
        }
      </mat-form-field>

      <mat-button-toggle-group [value]="viewMode()" (change)="viewMode.set($event.value)" aria-label="View mode">
        <mat-button-toggle value="card" matTooltip="Card view">
          <mat-icon>grid_view</mat-icon>
        </mat-button-toggle>
        <mat-button-toggle value="table" matTooltip="Table view">
          <mat-icon>table_rows</mat-icon>
        </mat-button-toggle>
      </mat-button-toggle-group>
    </div>
    }
  </div>

  <!-- Loading State -->
  @if (loading()) {
  <div class="flex flex-col items-center justify-center py-24 gap-4">
    <mat-spinner diameter="48" />
    <p class="text-sm text-gray-500">Loading users…</p>
  </div>
  }

  <!-- Error State -->
  @if (error()) {
  <div class="flex flex-col items-center justify-center py-24 gap-4 text-center">
    <mat-icon class="!text-5xl text-red-400">error_outline</mat-icon>
    <p class="text-gray-600">{{ error() }}</p>
    <button mat-flat-button color="primary" (click)="retry()">
      <mat-icon>refresh</mat-icon>
      Retry
    </button>
  </div>
  }

  <!-- Empty Search Result -->
  @if (!loading() && !error() && filteredUsers().length === 0) {
  <div class="flex flex-col items-center justify-center py-24 gap-3 text-center">
    <mat-icon class="!text-5xl text-gray-300">person_search</mat-icon>
    <p class="text-gray-500">No users match <strong>"{{ searchControl.value }}"</strong></p>
    <button mat-stroked-button (click)="searchControl.setValue('')">Clear search</button>
  </div>
  }

  <!-- User Cards Grid -->
  @if (!loading() && !error() && filteredUsers().length > 0 && viewMode() === 'card') {
  <div class="users-grid">
    @for (user of filteredUsers(); track user.login.uuid) {
    <mat-card appearance="outlined" class="user-card" (click)="openDetail(user)" role="button"
      tabindex="0" (keydown.enter)="openDetail(user)" [attr.aria-label]="'View details for ' + fullName(user)">
      <mat-card-content>
        <div class="flex gap-4 items-start">
          <!-- Avatar -->
          <img
            [src]="user.picture.medium"
            [alt]="fullName(user)"
            class="user-avatar"
            loading="lazy"
            width="72"
            height="72"
          />

          <!-- Info -->
          <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-2">
              <div>
                <p class="font-semibold text-gray-900 truncate">{{ fullName(user) }}</p>
                <p class="text-xs text-gray-500 capitalize">{{ user.gender }} · Age {{ user.dob.age }}</p>
              </div>
              <mat-chip class="!text-xs !shrink-0">{{ user.nat }}</mat-chip>
            </div>

            <div class="mt-2 flex flex-col gap-1">
              <a
                [href]="'mailto:' + user.email"
                class="flex items-center gap-1.5 text-xs text-indigo-600 hover:underline truncate"
                [matTooltip]="user.email"
              >
                <mat-icon class="!text-sm !w-4 !h-4 !leading-none">email</mat-icon>
                {{ user.email }}
              </a>

              <p class="flex items-center gap-1.5 text-xs text-gray-500 truncate">
                <mat-icon class="!text-sm !w-4 !h-4 !leading-none">phone</mat-icon>
                {{ user.phone }}
              </p>

              <p class="flex items-center gap-1.5 text-xs text-gray-500 truncate">
                <mat-icon class="!text-sm !w-4 !h-4 !leading-none">location_on</mat-icon>
                {{ user.location.city }}, {{ user.location.country }}
              </p>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
    }
  </div>
  }

  <!-- User Table -->
  @if (!loading() && !error() && filteredUsers().length > 0 && viewMode() === 'table') {
  <div class="users-table-wrapper">
    <table mat-table [dataSource]="tableDataSource" class="users-table w-full">

      <!-- Avatar Column -->
      <ng-container matColumnDef="avatar">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let user">
          <img [src]="user.picture.thumbnail" [alt]="fullName(user)" class="table-avatar" width="40" height="40" />
        </td>
      </ng-container>

      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Name</th>
        <td mat-cell *matCellDef="let user">
          <p class="font-medium text-gray-900 text-sm">{{ fullName(user) }}</p>
          <p class="text-xs text-gray-400 capitalize">{{ user.gender }} · Age {{ user.dob.age }}</p>
        </td>
      </ng-container>

      <!-- Email Column -->
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef>Email</th>
        <td mat-cell *matCellDef="let user">
          <a [href]="'mailto:' + user.email" class="text-sm text-indigo-600 hover:underline" [matTooltip]="user.email">
            {{ user.email }}
          </a>
        </td>
      </ng-container>

      <!-- Phone Column -->
      <ng-container matColumnDef="phone">
        <th mat-header-cell *matHeaderCellDef>Phone</th>
        <td mat-cell *matCellDef="let user" class="text-sm text-gray-600">{{ user.phone }}</td>
      </ng-container>

      <!-- Location Column -->
      <ng-container matColumnDef="location">
        <th mat-header-cell *matHeaderCellDef>Location</th>
        <td mat-cell *matCellDef="let user" class="text-sm text-gray-600">
          {{ user.location.city }}, {{ user.location.country }}
        </td>
      </ng-container>

      <!-- Nationality Column -->
      <ng-container matColumnDef="nat">
        <th mat-header-cell *matHeaderCellDef>Nat</th>
        <td mat-cell *matCellDef="let user">
          <mat-chip class="!text-xs">{{ user.nat }}</mat-chip>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="tableColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: tableColumns;" class="table-row"
        (click)="openDetail(row)" [attr.aria-label]="'View details for ' + fullName(row)"></tr>
    </table>
    <mat-paginator
      [pageSizeOptions]="[10, 25, 50]"
      pageSize="10"
      showFirstLastButtons
      aria-label="Select page of users"
      class="table-paginator"
    />
  </div>
  }

  <!-- Credit -->
  @if (!loading() && !error()) {
  <p class="text-xs text-gray-400 text-right">
    User data provided by
    <a href="https://randomuser.me/" target="_blank" rel="noopener noreferrer"
      class="text-indigo-500 hover:underline">randomuser.me</a>
  </p>
  }
</div>
